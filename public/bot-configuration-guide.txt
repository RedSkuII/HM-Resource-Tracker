====================================================================
DISCORD BOT CONFIGURATION GUIDE
Resource Tracker - Complete Bot Dashboard Documentation
====================================================================

OVERVIEW
--------
The Bot Dashboard provides a complete interface for configuring Discord 
bot integration. This guide covers server selection, channel/role 
configuration, points system, and bot implementation.

QUICK TIP
---------
Hold Ctrl (Windows/Linux) or Cmd (Mac) to select multiple channels 
or roles in the dropdowns below.

====================================================================
SERVER SELECTION & SORTING
====================================================================

Discord Server Dropdown:
- Select which Discord server to configure
- Automatically sorted: Servers with bot installed first (âœ…), then 
  servers without bot (âš ï¸)
- Owner servers marked with ðŸ‘‘ crown icon
- Shows real-time bot presence status
- Only displays servers where you have Administrator permissions or 
  ownership

In-Game Guild Dropdown:
- Select which in-game guild (House, Clan) to track
- Filtered by selected Discord server
- Links resources to specific Discord communities
- Each Discord server can track a different in-game guild

Adding Bot to Server:
1. Select your Discord server from dropdown
2. If bot not present, click "Add Bot to Server" button
3. Authorize with Administrator permissions
4. Refresh page to see configuration panel

====================================================================
CHANNEL CONFIGURATION (MULTI-SELECT)
====================================================================

Bot Channels - Where the bot posts notifications:
â€¢ Select multiple channels (hold Ctrl/Cmd)
â€¢ Examples: #announcements, #bot-logs, #resource-tracker
â€¢ Used for: Website change notifications, general bot messages
â€¢ Visual tags show selected channels with quick removal (Ã—)

Order Channels - Where resource orders are created:
â€¢ Select multiple channels for order management
â€¢ Examples: #orders, #requests, #marketplace
â€¢ Used for: Public order system, fulfillment tracking
â€¢ Supports Discord slash commands for creating/filling orders

====================================================================
ROLE CONFIGURATION (MULTI-SELECT)
====================================================================

Admin Roles - Roles that can access the bot dashboard:
â€¢ Select multiple roles (hold Ctrl/Cmd)
â€¢ Examples: @Admin, @Moderator, @Officers
â€¢ Grants access to: Configuration changes, statistics, activity logs
â€¢ Separate from resource permissions (controlled via DISCORD_ROLES_CONFIG 
  environment variable)

====================================================================
POINTS & BONUS SYSTEM
====================================================================

Discord Order Fulfillment Bonus: 0-200%
----------------------------------------
â€¢ Default: 50% (1.5x points)
â€¢ Controls point multiplier for filling orders via Discord bot
â€¢ Scaling:
  - 0% = No bonus (1.0x base points)
  - 50% = 1.5x points (recommended)
  - 100% = 2.0x points (double points)
  - 200% = 3.0x points (triple points)
â€¢ Purpose: Encourages Discord-based resource distribution

Website Resource Addition Bonus: 0-200%
----------------------------------------
â€¢ Default: 0% (no bonus)
â€¢ Controls point multiplier for adding resources via website
â€¢ Same scaling as Discord bonus
â€¢ Use cases:
  - Set higher to encourage website usage
  - Set lower to prioritize Discord activity
  - Match Discord bonus for equal rewards

Point Calculation Examples:
---------------------------
â€¢ Base points for adding 1000 resources = 100 points (0.1 per resource)
â€¢ With 100% website bonus = 200 points
â€¢ With 200% website bonus = 300 points
â€¢ Filling Discord order with 50% bonus = 150 points per 1000 resources

Note: Bonuses only apply to ADD actions, not SET or REMOVE operations.
Status bonuses (critical +10%, below target +5%) also apply separately.

====================================================================
BOT BEHAVIOR TOGGLES
====================================================================

âœ… Auto-Update Discord Embeds
-----------------------------
â€¢ Enabled: Bot edits existing embed messages when data changes
â€¢ Disabled: Creates new messages for each update (historical record)
â€¢ Use case: Keep pinned stock messages synchronized in real-time
â€¢ Prevents: Channel spam from repeated new messages
â€¢ Recommendation: Enable for most servers

âœ… Notify on Website Resource Changes
--------------------------------------
â€¢ Enabled: Bot posts notifications when resources are added/removed 
  via website
â€¢ Disabled: Only Discord-based changes trigger notifications
â€¢ Use case: Keep Discord community informed of website activity
â€¢ Example notification: "ðŸ”” @Username added 1000x Iron Ore (+10 points)"
â€¢ Recommendation: Enable for active guilds with website users

âœ… Allow Public Orders
----------------------
â€¢ Enabled: Any guild member can create resource requests via Discord
â€¢ Disabled: Only admins/designated roles can manage orders
â€¢ Use case: Democratic resource distribution vs. centralized control
â€¢ Example command: /order create Metal Alloy 500
â€¢ Recommendation: Enable for community-driven guilds, disable for 
  admin-controlled distribution

====================================================================
CONFIGURATION WORKFLOW FOR SERVER OWNERS
====================================================================

Step 1: Add Bot to Discord Server
----------------------------------
â€¢ Select your server from dropdown
â€¢ If bot not present, click "Add Bot to Server" button
â€¢ Authorize with Administrator permissions
â€¢ Refresh page to see configuration panel

Step 2: Select In-Game Guild
-----------------------------
â€¢ Choose which in-game guild (House, Clan) to track
â€¢ This links your Discord server to resource tracking
â€¢ Each Discord server can track a different in-game guild

Step 3: Configure Channels
---------------------------
â€¢ Select Bot Channels (where bot posts notifications)
  - Hold Ctrl/Cmd to select multiple
  - Examples: #announcements, #bot-logs
â€¢ Select Order Channels (where users can request resources)
  - Hold Ctrl/Cmd to select multiple
  - Examples: #orders, #marketplace

Step 4: Configure Admin Roles
------------------------------
â€¢ Select roles that can manage bot configuration
â€¢ Hold Ctrl/Cmd to select multiple roles
â€¢ Examples: @Admin, @Moderator, @Officers

Step 5: Set Point Bonuses
--------------------------
â€¢ Discord Order Fulfillment Bonus: 0-200% (recommended: 50%)
â€¢ Website Addition Bonus: 0-200% (recommended: 0-100%)
â€¢ Balance between Discord and website engagement

Step 6: Enable Features
------------------------
â€¢ Toggle Auto-update embeds (recommended: ON)
â€¢ Toggle Website notifications (recommended: ON for active guilds)
â€¢ Toggle Public orders (ON for community-driven, OFF for admin-controlled)

Step 7: Save Configuration
---------------------------
â€¢ Click "Save Configuration" button
â€¢ Settings are stored per Discord server
â€¢ Each server can have completely different settings

Step 8: Verify Bot Functionality
---------------------------------
â€¢ Check bot appears online in your Discord server
â€¢ Test bot commands in configured channels
â€¢ Verify notifications appear when resources change
â€¢ Check points are awarded correctly

====================================================================
MULTI-SERVER BEST PRACTICES
====================================================================

Understanding Multi-Server Architecture:
----------------------------------------
â€¢ Each Discord server can have independent bot configuration
â€¢ Multiple Discord servers can track the same in-game guild (for 
  alliances)
â€¢ Resources are shared across all Discord servers linked to the same 
  in-game guild
â€¢ Leaderboards show contributions from all linked Discord servers
â€¢ Each server can have different bonus percentages and notification 
  settings

Recommended Configurations:
----------------------------
â€¢ Single In-Game Guild, Multiple Discord Servers:
  - Alliance scenario: Multiple Discord communities sharing resources
  - Each server configures their own channels and roles
  - Points tracked globally across all servers
  - Set similar bonus percentages for fairness

â€¢ Multiple In-Game Guilds, Single Discord Server:
  - Multi-faction scenario: Tracking different Houses/Clans
  - Create separate channels for each guild
  - Configure bot for primary guild only
  - Use website for other guilds

â€¢ Multiple Servers, Multiple Guilds:
  - Complex organization with separate communities
  - Each server links to their primary in-game guild
  - Independent tracking and leaderboards
  - Separate admin teams per server

Important Notes:
----------------
â€¢ Admin roles are server-specific, not shared across servers
â€¢ Bot presence must be confirmed before configuration appears
â€¢ Configuration changes only affect the selected Discord server
â€¢ In-game guild resources are shared, but Discord permissions are not

====================================================================
TROUBLESHOOTING
====================================================================

âŒ Can't see my Discord server in the list?
-------------------------------------------
â€¢ Ensure you've granted the app permission to see your servers when 
  logging in
â€¢ Required OAuth scopes: identify, guilds, guilds.members.read
â€¢ Try logging out and back in to refresh Discord token
â€¢ Check Discord Developer Mode is enabled
â€¢ Verify you have Administrator permissions or ownership on the server

âš ï¸ Server shows "Bot needs to be added to this server"?
-------------------------------------------------------
â€¢ The bot isn't installed on that server yet
â€¢ Only servers where the bot is installed can be configured
â€¢ Click "Add Bot to Server" button to install
â€¢ Grant Administrator permissions during installation
â€¢ Refresh page after bot is added

ðŸ”„ Changes not saving?
----------------------
â€¢ Check browser console (F12) for detailed error messages
â€¢ Ensure you've selected at least one in-game guild
â€¢ Verify you have admin permissions on the Discord server
â€¢ Check that at least one channel/role is selected (or leave empty)
â€¢ Ensure bot is present in the server
â€¢ Try refreshing the page and attempting again

ðŸ“Š Bot not posting updates?
---------------------------
â€¢ Ensure "Auto-Update Discord Embeds" is enabled in dashboard
â€¢ Check that the bot has permissions to post in selected bot channels
â€¢ Verify channel IDs are correct (no deleted channels selected)
â€¢ Ensure bot has "Send Messages" and "Embed Links" permissions
â€¢ Check bot is online in your Discord server
â€¢ Review bot logs for connection errors

ðŸ” Permission errors when configuring?
--------------------------------------
â€¢ Verify you're an Administrator or Owner on the Discord server
â€¢ Check that your Discord roles are properly synced
â€¢ Ensure DISCORD_ROLES_CONFIG environment variable is correctly formatted
â€¢ Try signing out and signing back in
â€¢ Contact your server owner for role assignment

âš¡ Bot commands not working?
----------------------------
â€¢ Configuration is stored, but bot implementation is separate
â€¢ Ensure your Discord bot code is running (separate from website)
â€¢ Check bot token is valid in DISCORD_BOT_TOKEN environment variable
â€¢ Verify bot has Slash Command permissions
â€¢ Confirm bot is reading config from API endpoint correctly
â€¢ Check bot framework (Discord.js/discord.py) is up to date

ðŸŒ Website integration issues?
------------------------------
â€¢ Verify NEXTAUTH_URL matches your deployed URL
â€¢ Check all environment variables are set correctly
â€¢ Ensure Turso database connection is working
â€¢ Run npm run db:push to apply schema migrations
â€¢ Check Vercel deployment logs for errors
â€¢ Verify Discord OAuth redirect URI matches deployment URL

====================================================================
API ENDPOINTS FOR BOT DEVELOPERS
====================================================================

The website provides REST API endpoints that your Discord bot can use
to read configuration and interact with resources. All endpoints
require proper authentication.

Configuration Endpoints:
------------------------
GET /api/bot/config/{guildId}
â€¢ Retrieve bot configuration for a specific Discord server
â€¢ Returns: Bot channels, order channels, admin roles, bonuses, toggles
â€¢ Use this to configure your bot's behavior per server
â€¢ Example response:
  {
    "guildId": "123456789",
    "inGameGuildId": "guild_abc",
    "botChannelId": ["channel1", "channel2"],
    "orderChannelId": ["channel3"],
    "adminRoleId": ["role1", "role2"],
    "autoUpdateEmbeds": true,
    "notifyOnWebsiteChanges": true,
    "allowPublicOrders": true,
    "orderFulfillmentBonus": 50,
    "websiteBonusPercentage": 100
  }

PUT /api/bot/config/{guildId}
â€¢ Update bot configuration (requires authentication)
â€¢ Used by the dashboard to save settings
â€¢ Not typically called by Discord bot directly

Resource Endpoints:
-------------------
GET /api/resources?guildId={guildId}
â€¢ Retrieve all resources for an in-game guild
â€¢ Returns: Array of resources with quantities, categories, status
â€¢ Use this for /stock or /inventory bot commands
â€¢ Supports pagination with page and limit parameters

PUT /api/resources
â€¢ Update resource quantities (awards points automatically)
â€¢ Requires authentication
â€¢ Use this when bot processes orders or manual updates
â€¢ Include: resourceId, quantity, changeType, reason, updatedBy

GET /api/resources/{resourceId}
â€¢ Get details for a specific resource
â€¢ Returns: Name, quantity, category, target, status, last update

Leaderboard Endpoints:
----------------------
GET /api/leaderboard?guildId={guildId}
â€¢ Get top contributors for an in-game guild
â€¢ Returns: Username, total points, contribution counts
â€¢ Use this for /leaderboard bot command
â€¢ Includes points from both Discord and website actions

User & Server Endpoints:
-------------------------
GET /api/discord/user-servers
â€¢ Get list of Discord servers the authenticated user manages
â€¢ Used by dashboard for server dropdown
â€¢ Requires user authentication (not typically used by bot)

GET /api/discord/bot-status/{guildId}
â€¢ Check if the bot is present in a Discord server
â€¢ Returns: { isPresent: true/false }
â€¢ Used by dashboard to show bot presence indicators

Authentication:
---------------
â€¢ Most endpoints require NextAuth.js session authentication
â€¢ Bot should use service account or API key for server-to-server calls
â€¢ For bot commands, verify user permissions before allowing actions
â€¢ Check user's Discord roles against adminRoleId from config

Rate Limiting:
--------------
â€¢ Respect API rate limits (check response headers)
â€¢ Implement caching for frequently accessed data
â€¢ Don't poll /api/resources more than once per minute
â€¢ Use webhooks or database triggers for real-time updates (advanced)

Example Bot Implementation Flow:
---------------------------------
1. Bot starts up, reads config from /api/bot/config/{guildId}
2. Register slash commands based on config (public orders, etc.)
3. When /stock command used, fetch from /api/resources
4. When order filled, update via /api/resources (awards points)
5. Poll for changes or implement webhook to detect website updates
7. Post notifications to configured bot channels
8. Update embeds in Discord when resources change

====================================================================
DISCORD BOT IMPLEMENTATION GUIDE
====================================================================

Important: The website provides configuration storage and APIs, but
you need to implement a separate Discord bot to use these features.

Required Bot Setup:
-------------------
1. Create bot at Discord Developer Portal
   â€¢ Go to https://discord.com/developers/applications
   â€¢ Click "New Application"
   â€¢ Go to "Bot" tab and click "Add Bot"
   â€¢ Copy bot token for later use

2. Enable required intents:
   â€¢ Server Members Intent (for role checking)
   â€¢ Message Content Intent (optional, for prefix commands)
   â€¢ Presence Intent (optional, for status updates)

3. Configure bot permissions:
   â€¢ Administrator (recommended for full functionality)
   â€¢ Or minimum: Send Messages, Embed Links, Read Messages, 
     Use Slash Commands, Manage Messages

4. Add bot to your server:
   â€¢ Use OAuth2 URL Generator in Developer Portal
   â€¢ Select "bot" and "applications.commands" scopes
   â€¢ Select required permissions
   â€¢ Use generated URL to add bot to servers

Environment Variables for Bot:
-------------------------------
DISCORD_BOT_TOKEN=your_bot_token_here
WEBSITE_API_URL=https://your-resource-tracker.vercel.app
NEXTAUTH_SECRET=same_secret_as_website_for_api_auth

Recommended Bot Features to Implement:
---------------------------------------
Core Commands:
â€¢ /stock - Show current resource levels (read from /api/resources)
â€¢ /leaderboard - Show top contributors (read from /api/leaderboard)
â€¢ /help - Display bot commands and usage

Order Management (if allowPublicOrders enabled):
â€¢ /order create [item] [quantity] - Create resource request
â€¢ /order fill [order_id] - Fulfill an order (awards bonus points)
â€¢ /order list - Show pending orders
â€¢ /order cancel [order_id] - Cancel your order

Admin Commands (restricted to adminRoleId):
â€¢ /config show - Display current bot configuration
â€¢ /config reload - Refresh config from website API
â€¢ /stock update [item] [quantity] - Manual resource update
â€¢ /stock refresh - Force refresh stock embed

Notification Features:
â€¢ Auto-update stock embeds when website data changes
â€¢ Post notifications when resources updated via website
â€¢ Alert when resources reach critical status
â€¢ Announce new high scores on leaderboard

Example Bot Architecture (Discord.js):
---------------------------------------
const { Client, IntentsBitField, REST, Routes } = require('discord.js');

const client = new Client({
  intents: [
    IntentsBitField.Flags.Guilds,
    IntentsBitField.Flags.GuildMembers
  ]
});

// On bot startup
client.once('ready', async () => {
  // Load config from website API
  const config = await fetch(`${API_URL}/api/bot/config/${guildId}`)
    .then(r => r.json());
  
  // Register slash commands
  registerCommands(client, config);
  
  // Start polling for resource changes (or use webhooks)
  setInterval(() => checkForUpdates(config), 60000);
});

// Handle slash commands
client.on('interactionCreate', async (interaction) => {
  if (!interaction.isChatInputCommand()) return;
  
  if (interaction.commandName === 'stock') {
    // Fetch resources from API
    const resources = await fetch(`${API_URL}/api/resources?guildId=${guildId}`)
      .then(r => r.json());
    
    // Create embed and reply
    await interaction.reply({ embeds: [createStockEmbed(resources)] });
  }
  
  if (interaction.commandName === 'order') {
    // Handle order creation/fulfillment
    // Award points via PUT /api/resources
  }
});

Example Bot Architecture (discord.py):
---------------------------------------
import discord
from discord import app_commands
import aiohttp

class ResourceBot(discord.Client):
    def __init__(self):
        intents = discord.Intents.default()
        intents.members = True
        super().__init__(intents=intents)
        self.tree = app_commands.CommandTree(self)
    
    async def on_ready(self):
        # Load config from website API
        async with aiohttp.ClientSession() as session:
            async with session.get(f'{API_URL}/api/bot/config/{guild_id}') as r:
                self.config = await r.json()
        
        # Sync slash commands
        await self.tree.sync()
        
        # Start background tasks
        self.loop.create_task(self.check_for_updates())

@bot.tree.command(name="stock", description="Show current resource levels")
async def stock(interaction: discord.Interaction):
    async with aiohttp.ClientSession() as session:
        async with session.get(f'{API_URL}/api/resources?guildId={guild_id}') as r:
            resources = await r.json()
    
    embed = create_stock_embed(resources)
    await interaction.response.send_message(embed=embed)

Best Practices:
---------------
â€¢ Cache config from /api/bot/config, reload periodically
â€¢ Use embeds for rich formatting
â€¢ Implement permission checks before allowing commands
â€¢ Handle API errors gracefully (timeouts, rate limits)
â€¢ Log all bot actions for debugging
â€¢ Use slash commands instead of prefix commands
â€¢ Implement cooldowns on resource-intensive commands
â€¢ Store order data in your own database or use website API

Testing Your Bot:
-----------------
1. Start bot locally with test token
2. Add to your test Discord server
3. Configure bot channels and roles via website dashboard
4. Test each slash command
5. Verify points are awarded correctly
6. Check notifications appear in configured channels
7. Test permission restrictions
8. Monitor for errors and fix issues

====================================================================
ADDITIONAL RESOURCES
====================================================================

Environment Variables:
----------------------
For complete list of environment variables and configuration options,
see ENVIRONMENT.md in the repository or contact your system administrator.

Key variables:
â€¢ DISCORD_CLIENT_ID - Your Discord OAuth app client ID
â€¢ DISCORD_CLIENT_SECRET - Your Discord OAuth app secret
â€¢ DISCORD_BOT_TOKEN - Your Discord bot token (for bot features)
â€¢ DISCORD_ROLES_CONFIG - JSON array defining role permissions
â€¢ NEXTAUTH_SECRET - Secret for session encryption
â€¢ TURSO_DATABASE_URL - Database connection URL
â€¢ TURSO_AUTH_TOKEN - Database authentication token

Database Schema:
----------------
Main tables:
â€¢ users - Discord user profiles
â€¢ guilds - In-game guilds (Houses, Clans)
â€¢ resources - Resource inventory with quantities
â€¢ resource_history - Audit trail of all changes
â€¢ user_points - Leaderboard scores
â€¢ bot_configurations - Discord bot settings per server

For schema details, see database-schema.md or use Drizzle Studio:
npm run db:studio

Deployment Guide:
-----------------
â€¢ Free deployment on Vercel + Turso
â€¢ Supports serverless and edge runtime
â€¢ Automatic deployments from GitHub
â€¢ Environment variables configured in Vercel dashboard
â€¢ Database migrations via npm run db:push

For detailed deployment steps, see DEPLOYMENT.md

Discord Bot Frameworks:
-----------------------
â€¢ Discord.js (JavaScript/TypeScript) - https://discord.js.org
â€¢ discord.py (Python) - https://discordpy.readthedocs.io
â€¢ Discord4J (Java) - https://discord4j.com
â€¢ Discordia (Lua) - https://github.com/SinisterRectus/Discordia

====================================================================
NEED SUPPORT?
====================================================================

For additional help, feature requests, or bug reports:
â€¢ Contact your server administrator or system owner
â€¢ Check the main dashboard for system announcements
â€¢ Review your bot configuration settings carefully
â€¢ Consult the README.md file in the repository
â€¢ Check deployment logs in Vercel dashboard
â€¢ Review database logs in Turso dashboard

Common Support Scenarios:
-------------------------
â€¢ Configuration issues â†’ Check environment variables
â€¢ Permission errors â†’ Verify Discord roles and OAuth scopes
â€¢ Bot offline â†’ Check bot token and hosting service
â€¢ Database errors â†’ Run npm run db:push to apply migrations
â€¢ Points not awarded â†’ Check bonus settings and action type (ADD vs SET)

====================================================================
TECHNICAL SPECIFICATIONS
====================================================================

Technology Stack:
-----------------
â€¢ Frontend: Next.js 14 (App Router), React, TypeScript
â€¢ Styling: Tailwind CSS with dark mode support
â€¢ Authentication: NextAuth.js with Discord OAuth
â€¢ Database: Turso (libSQL/SQLite), Drizzle ORM
â€¢ Hosting: Vercel (Edge Runtime compatible)
â€¢ Bot Framework: Your choice (Discord.js, discord.py, etc.)

Performance Characteristics:
----------------------------
â€¢ JWT session tokens: 4-hour lifespan
â€¢ API response times: <100ms (typical)
â€¢ Database queries: Indexed for fast lookups
â€¢ Pagination: 25 items per page default
â€¢ Real-time updates: Poll every 60 seconds or use webhooks

Security Features:
------------------
â€¢ Discord OAuth 2.0 authentication
â€¢ Role-based access control (RBAC)
â€¢ CSRF protection via NextAuth
â€¢ Environment variable encryption
â€¢ SQL injection prevention (Drizzle ORM parameterized queries)
â€¢ GDPR compliance: Data export and deletion

====================================================================
VERSION INFORMATION
====================================================================

Resource Tracker Version: 1.0
Last Updated: November 2025
Documentation Version: 2.0

Compatibility:
--------------
â€¢ Next.js: 14.x
â€¢ Node.js: 18.x or higher
â€¢ Discord API: v10
â€¢ Turso: Latest
â€¢ Modern browsers: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+

====================================================================
END OF DOCUMENTATION
====================================================================

This documentation covers the Discord Bot Configuration Dashboard.
For complete system documentation including deployment, customization,
and advanced features, consult the full documentation set in your
repository or contact your system administrator.

Thank you for using Resource Tracker!
